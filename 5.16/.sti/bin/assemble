#!/bin/bash

source scl_source enable perl516

set -eu

echo "---> Installing application source"
cp -Rf /tmp/src/* ./


# TODO
MIRROR=
DISABLE_TEST=--notest

# Installing dependencies with cpanfile
if [ -f "cpanfile" ]
then
	CPANM=`which cpanm`
	echo "---> Installing modules from cpanfile"
	perl $CPANM $MIRROR $DISABLE_TEST -l extlib Module::CoreList
	perl -Iextlib/lib/perl5 $CPANM $MIRROR $DISABLE_TEST -l extlib --installdeps .
else
	echo "---> No cpanfile found, exiting"
	exit 1
#	TODO: Should we support this? If yes, we need to install rpm-build for /usr/lib/rpm/perl.req
#	EXCLUDED_PRAGMAS=("perl" "strict" "warnings" "constant" "open" "lib" "vars" "base" "utf8")
#	DEPS=$(find . -type f -name '*.p[ml]')
#
#	for f in $(echo "$DEPS" | xargs /usr/lib/rpm/perl.req | awk '{ print $1 }' | sed 's/^perl(\(.*\))$/\1/' | sort -u | grep .)
#	do
#		# Skipping well-known perl pragmas
#		for element in ${EXCLUDED_PRAGMAS[@]}; do
#			[[ $element == $f ]] && continue 2
#		done
#
#		DISABLE_TEST="-n"
#		if [ -z "${ENABLE_CPAN_TESTS}" ]
#		then
#			echo ".openshift/markers/enable_cpan_tests!  enabling default cpan tests" 1>&2
#			DISABLE_TEST=""
#		fi
#
#		# Do not error the build when the CPAN module failed to install, but report
#		# it to user. This will allow modules that are not local, nor CPAN to pass
#		# the build.
#		cpanm $DISABLE_TEST $MIRROR -L ${OPENSHIFT_PERL_DIR}extlib "$f"
#
#	done
fi
